# Инфраструктура

 - Билд-агент - [Readme.md](build-agent/README.md)
 - Билд-сервер - [Readme.md](build-server/README.md)
 
 *Требования*
 
_Сервер должен максимально утилизировать имеющихся агентов_

Алгоритм

 * Билд-сервер с интервалом проверяет очередь билдов;
 * Находит билды в статусе Waiting;
 * Смотрит список зарегистрированных агентов;
 * Находит свободные агенты и ставит задачу на выполнение;
 * Если есть задача, но нет свободных агентов, ждет,
 когда агент освободится.
 
 Т.о билд-агенты не простаивают.
 
 Из особенностей: сервер проверяет первые 100 билдов в очереди на статус `Waiting`.
 Кол-во регулируется параметром в `agent-conf.json`. 
 
 Может возникнуть ситуация, когда в очереди 105 билдов в статусе `Waiting`,
 тогда первые 5 билдов не обработаются сервером. 

**Решить проблему** можно добавлением в api ручки для получения всех билдов в статусе `Waiting` 
либо ограничить очередь билдов на выполнение. 
 
_Сервер должен корректно обрабатывать ситуацию, когда агент прекратил работать между сборками_

_Сервер должен корректно обрабатывать ситуацию, когда агент прекратил работать в процессе выполнения сборки_

Алгоритм

* Выполнение билда на агенте кэшируется в билд-сервере;
* Билд-сервер периодически проверяет кэш, находит занятые агены,
сравнивает с таймаутом (таймаут на время выполнения сборки);
* Если выполнение билда превышает таймаут, билд-сервер отписывает агента,
билд переводит в статус `Cancel`.

Т.о считаем, что с агентом возникли неполадки и нужно вручном режиме проверить его работоспособность.
Понять, что с агентом проблемы, можно по отмененному билду в CI.

Может возникнуть ситуация, когда агента отписали, а билд просто долго выполнялся, тогда
агент попробует отправить результаты прогона. При отправке возникнет ошибка, потому что
текущий билд был отменен.
 
_Агент должен корректно обрабатывать ситуацию, когда при старте не смог соединиться с сервером_

_Агент должен корректно обрабатывать ситуацию, когда при отправке результатов сборки не смог соединиться с сервером_

# CI

 - Cервер - [Readme.md](server/README.md)
 - Клиент - [Readme.md](client/README.md)

## Автотесты

Написаны автотесты на клиенте и сервере.
Предварительно разбил систему на логические блоки.

Серверная часть:
* Роутинг запросов;
* Работа с гитом;
* Работа с кэшем;
* Работа с api-внешнего сервиса (предпологаем, что разработчики сервиса
провели тестирование api).

Клиентская часть:
* Работа с состоянием компонентов (state компонента, общее хранилище состояний redux);
* Работа с side effects (запросы к api-внешнего сервиса, sagas);
* Интерфейс (отображение компонентов, валидация форм, редиректы, клики).

### Модульные

В силу ограничения по времени, модульными автотестами покрыта только
серверная часть приложения - логический блок роутинг.

Для запуска необходимо:

1. Перейти в папку - `cd server/test`;
2. Запустить тесты - `npm run test`.

Покрыты ручки:

* GET api/settings
* POST api/settings
* GET api/builds
* POST /api/builds/:commitHash
* GET /api/builds/:buildId

api-внешнего сервиса замокано с помощью библиотеки `axios-mock-adapter`.
Утилитарные методы для работы с гитом обернуты в stub библиотеки `sinon.js`.

Сейчас тестируется только корректная работа роута, без логики утилитарных методов.
Для полноценного покрытия еще нужно покрыть утилитарные методы. Их пока не успел
дописать( В процессе.
 
### Интеграционные
В силу ограничения по времени интеграционными тестами покрыта только часть
функционала - редирект, форма валидации.

Для запуска необходимо:

1. Перейти в папку - `cd /client`;
1. Поднять standalone server selenium;
2. Запустить тесты `npm run test`.

## TODO

Замечания, которые остались и планируются дорабатываться:

- Заменить стандартную иконку в полях ввода на иконку из макета;
- Удалить избыточные компоненты;
- Ввести bem-naming для React;
- Уменьшить уровень вложенности в контентных блоках;
- Исправить баги в верстке, доработать адаптивность;
- Вынести в утилитарный файл общие селекторы;
- Добавить scroll в history;
- Придумать нормальную композицию компонентов (либо затащить композицию
  bem-react-core при переносе на типизацию);
- Вынести повторяющийся код в утилитарные файл;
- Разбить компоненты на базовые и контентные;
- Добавить ssr;
- Исправить переход на карточку билда по /url
- Поправить баги при сохранении формы Run Build
- Объединить package.json клиента и сервера
